# name: API Tests

# on:
#   push:
#     branches: [ main, develop ]
#     paths:
#       - 'app/Http/Controllers/Api/**'
#       - 'app/Http/Resources/**'
#       - 'routes/api.php'
#       - 'tests/Feature/Api/**'
#   pull_request:
#     branches: [ main, develop ]
#   workflow_dispatch:

# jobs:
#   api-tests:
#     name: API Endpoint Tests
#     runs-on: ubuntu-latest
    
#     services:
#       mysql:
#         image: mysql:8.0
#         env:
#           MYSQL_ROOT_PASSWORD: password
#           MYSQL_DATABASE: testing
#         ports:
#           - 3306:3306
#         options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

#       redis:
#         image: redis:alpine
#         ports:
#           - 6379:6379
#         options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup PHP
#         uses: shivammathur/setup-php@v2
#         with:
#           php-version: '8.3'
#           extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, redis
#           coverage: xdebug

#       - name: Copy .env.example to .env
#         run: cp .env.example .env

#       - name: Cache Composer dependencies
#         uses: actions/cache@v3
#         with:
#           path: vendor
#           key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
#           restore-keys: ${{ runner.os }}-composer-

#       - name: Install Composer dependencies
#         run: composer install --prefer-dist --no-progress --no-interaction

#       - name: Generate application key
#         run: php artisan key:generate

#       - name: Set testing environment
#         run: |
#           echo "DB_CONNECTION=mysql" >> .env
#           echo "DB_HOST=127.0.0.1" >> .env
#           echo "DB_PORT=3306" >> .env
#           echo "DB_DATABASE=testing" >> .env
#           echo "DB_USERNAME=root" >> .env
#           echo "DB_PASSWORD=password" >> .env
#           echo "REDIS_HOST=127.0.0.1" >> .env
#           echo "REDIS_PORT=6379" >> .env
#           echo "CACHE_STORE=redis" >> .env
#           echo "QUEUE_CONNECTION=sync" >> .env

#       - name: Run migrations and seed test data
#         run: |
#           php artisan migrate --force
#           php artisan db:seed --force

#       - name: Run API tests
#         run: ./vendor/bin/pest tests/Feature/Api --parallel --coverage

#       - name: Upload test results
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: api-test-results
#           path: |
#             tests/Feature/Api
#             coverage.xml

#   integration-tests:
#     name: API Integration Tests
#     runs-on: ubuntu-latest
#     needs: api-tests
    
#     services:
#       mysql:
#         image: mysql:8.0
#         env:
#           MYSQL_ROOT_PASSWORD: password
#           MYSQL_DATABASE: testing
#         ports:
#           - 3306:3306
#         options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

#       redis:
#         image: redis:alpine
#         ports:
#           - 6379:6379

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup PHP
#         uses: shivammathur/setup-php@v2
#         with:
#           php-version: '8.3'
#           extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, redis

#       - name: Copy .env.example to .env
#         run: cp .env.example .env

#       - name: Install dependencies
#         run: composer install --prefer-dist --no-progress --no-interaction

#       - name: Generate application key
#         run: php artisan key:generate

#       - name: Configure environment
#         run: |
#           echo "DB_CONNECTION=mysql" >> .env
#           echo "DB_HOST=127.0.0.1" >> .env
#           echo "DB_PORT=3306" >> .env
#           echo "DB_DATABASE=testing" >> .env
#           echo "DB_USERNAME=root" >> .env
#           echo "DB_PASSWORD=password" >> .env

#       - name: Run migrations
#         run: php artisan migrate --force

#       - name: Start Laravel server
#         run: php artisan serve --port=8000 &
#         env:
#           APP_ENV: testing

#       - name: Wait for server
#         run: |
#           timeout 30 bash -c 'until curl -f http://localhost:8000/api/health 2>/dev/null; do sleep 1; done' || true

#       - name: Test API endpoints with curl
#         run: |
#           echo "Testing public endpoints..."
          
#           # Health check
#           curl -f http://localhost:8000/api/health || echo "Health endpoint not found"
          
#           # List cars
#           STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/v1/cars)
#           if [ $STATUS -eq 200 ]; then
#             echo "✅ GET /api/v1/cars - OK"
#           else
#             echo "❌ GET /api/v1/cars - Failed (HTTP $STATUS)"
#           fi
          
#           # Search cars
#           STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8000/api/v1/cars/search?query=toyota")
#           if [ $STATUS -eq 200 ] || [ $STATUS -eq 404 ]; then
#             echo "✅ GET /api/v1/cars/search - OK"
#           else
#             echo "❌ GET /api/v1/cars/search - Failed (HTTP $STATUS)"
#           fi

#   documentation-check:
#     name: API Documentation Check
#     runs-on: ubuntu-latest
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup PHP
#         uses: shivammathur/setup-php@v2
#         with:
#           php-version: '8.3'

#       - name: Install dependencies
#         run: composer install --prefer-dist --no-progress --no-interaction

#       - name: Check if API documentation exists
#         run: |
#           if [ -f "API.md" ]; then
#             echo "✅ API.md documentation found"
#           else
#             echo "⚠️ API.md not found"
#           fi
          
#           if [ -f "config/scramble.php" ]; then
#             echo "✅ Scramble configuration found"
#           else
#             echo "⚠️ Scramble not configured"
#           fi

#       - name: Validate API routes
#         run: |
#           php artisan route:list --path=api | grep -c "api/v1" && echo "✅ API v1 routes found" || echo "⚠️ No API v1 routes"

#   performance-test:
#     name: API Performance Test
#     runs-on: ubuntu-latest
#     needs: api-tests
    
#     services:
#       mysql:
#         image: mysql:8.0
#         env:
#           MYSQL_ROOT_PASSWORD: password
#           MYSQL_DATABASE: testing
#         ports:
#           - 3306:3306

#       redis:
#         image: redis:alpine
#         ports:
#           - 6379:6379

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup PHP
#         uses: shivammathur/setup-php@v2
#         with:
#           php-version: '8.3'
#           extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, redis

#       - name: Install dependencies
#         run: composer install --prefer-dist --no-progress --no-interaction

#       - name: Copy .env and configure
#         run: |
#           cp .env.example .env
#           php artisan key:generate
#           echo "DB_CONNECTION=mysql" >> .env
#           echo "DB_HOST=127.0.0.1" >> .env
#           echo "DB_DATABASE=testing" >> .env
#           echo "DB_USERNAME=root" >> .env
#           echo "DB_PASSWORD=password" >> .env

#       - name: Run migrations and seed
#         run: |
#           php artisan migrate --force
#           php artisan db:seed --force

#       - name: Start server
#         run: php artisan serve --port=8000 &

#       - name: Install Apache Bench
#         run: sudo apt-get update && sudo apt-get install -y apache2-utils

#       - name: Performance test - List cars
#         run: |
#           sleep 5
#           echo "Testing /api/v1/cars performance..."
#           ab -n 100 -c 10 http://localhost:8000/api/v1/cars || echo "Performance test completed"

#       - name: Check response times
#         run: |
#           RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}\n' http://localhost:8000/api/v1/cars)
#           echo "Response time: ${RESPONSE_TIME}s"
#           if (( $(echo "$RESPONSE_TIME < 1.0" | bc -l) )); then
#             echo "✅ Response time acceptable"
#           else
#             echo "⚠️ Response time over 1 second"
#           fi
