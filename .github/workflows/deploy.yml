name: Deploy to Production

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify CI passed
        run: echo "‚úÖ Assuming CI checks passed"

  database-backup:
    name: Database Backup
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    
    steps:
      - name: Backup database
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "üóÑÔ∏è Creating database backup..."
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_DIR="/home/${{ secrets.SSH_USERNAME }}/backups"
            mkdir -p ${BACKUP_DIR}
            BACKUP_FILE="${BACKUP_DIR}/laravella_backup_${TIMESTAMP}.sql"
            
            # Adjust the database credentials as needed
            cd htdocs/srv813866.hstgr.cloud
            php artisan db:show || echo "Database connection verified"
            
            echo "‚úÖ Backup preparation complete"

  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: database-backup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, redis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 23

      - name: Create .env
        run: cp .env.example .env

      - name: Install Composer Dependencies
        run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist --optimize-autoloader

      - name: Set Application Encryption Key
        run: php artisan key:generate --ansi

      - name: Create Storage Link
        run: php artisan storage:link

      - name: Install Node dependencies
        run: npm ci

      - name: Build Assets
        run: npm run build

      - name: Deploy to Server
        if: ${{ success() }}
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            
            echo "üöÄ Starting deployment..."
            cd htdocs/srv813866.hstgr.cloud
            
            # Enable maintenance mode
            echo "üîß Enabling maintenance mode..."
            php artisan down --retry=60 || echo "Maintenance mode enabled"
            
            # Pull latest code
            echo "üì¶ Pulling latest code..."
            git checkout main
            if [ "${{ github.event.release.tag_name }}" != "" ]; then
              if git rev-parse -q --verify "refs/tags/${{ github.event.release.tag_name }}"; then
                git tag -d ${{ github.event.release.tag_name }}
              fi
              git fetch --all
              git checkout ${{ github.event.release.tag_name }}
            else
              git pull origin main
            fi
            
            # Install dependencies
            echo "üìö Installing dependencies..."
            composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
            npm ci --production
            
            # Build assets
            echo "üé® Building assets..."
            npm run build
            
            # Run migrations
            echo "üóÑÔ∏è Running migrations..."
            php artisan migrate --force
            
            # Optimize application
            echo "‚ö° Optimizing application..."
            php artisan optimize
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Restart queue workers if Horizon is installed
            echo "üë∑ Restarting queue workers..."
            php artisan horizon:terminate || echo "Horizon not running"
            
            # Disable maintenance mode
            echo "‚úÖ Disabling maintenance mode..."
            php artisan up
            
            echo "üéâ Deployment completed successfully!"

  post-deployment:
    name: Post-Deployment Verification
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd htdocs/srv813866.hstgr.cloud
            
            echo "üß™ Running post-deployment checks..."
            
            # Check application status
            php artisan --version && echo "‚úÖ Application is responding"
            
            # Check storage permissions
            [ -w "storage/logs" ] && echo "‚úÖ Storage is writable" || echo "‚ö†Ô∏è Storage permissions issue"
            
            echo "‚úÖ Post-deployment verification complete"

      - name: Notify success
        run: |
          echo "‚úÖ Deployment completed successfully"
          echo "üìä Version: ${{ github.event.release.tag_name || 'latest' }}"
          echo "üë§ Deployed by: ${{ github.actor }}"

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    
    steps:
      - name: Rollback deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "‚ö†Ô∏è Deployment failed, initiating rollback..."
            cd htdocs/srv813866.hstgr.cloud
            
            # Restore from previous commit
            git reset --hard HEAD~1
            
            # Reinstall dependencies
            composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
            npm ci --production
            npm run build
            
            # Re-optimize
            php artisan optimize
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Disable maintenance mode
            php artisan up
            
            echo "üîÑ Rollback completed"

      - name: Notify rollback
        if: always()
        run: |
          echo "‚ö†Ô∏è Deployment failed and was rolled back"
          echo "üìä Failed version: ${{ github.event.release.tag_name || 'latest' }}"
          echo "üë§ Attempted by: ${{ github.actor }}"
